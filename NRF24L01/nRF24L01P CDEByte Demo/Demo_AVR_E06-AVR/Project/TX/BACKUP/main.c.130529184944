/* MAIN.C file
 *
 * Copyright (c) 2002-2005 STMicroelectronics
 */
#include "STM8l10x_conf.h"
#include "main.h"
#include "nRF24L01.h"
#include "board.h"
#include "Oled.h"

void main( void )
{
	INT32U dly;
    INT8U tmp,x,testbuffer[10] = {"00000"};
	INT16U tx_couter = 0, itmp;

	SPI_Initial( );
	GPIO_Initial( );


	//???L01+????CE
	GPIO_Init( GPIOA, GPIO_Pin_2, GPIO_Mode_Out_PP_High_Fast );
	GPIO_SetBits( GPIOA, GPIO_Pin_2 );// CE = 1

	//???L01+????IRQ,??????
	GPIO_Init( GPIOA, GPIO_Pin_3, GPIO_Mode_In_PU_No_IT );

	//L01+???,?????C?,?nRF24L01.h??,??SPI?CSN??,????????????
	//???????L01+?????????
	L01_Init( );
	L01_SetTRMode( TX_MODE );
	L01_WriteHoppingPoint( 60 );
	L01_SetSpeed( SPD_250K );

	//??LED
	GPIO_SetBits( GPIOB, GPIO_Pin_0 | GPIO_Pin_1 );

	LCD_Init( );
	LCD_Dis_Logo( );
	LCD_Dis_Str( 2,24,"STM8 board" );
    LCD_Dis_Str( 4,0,"yhmcu.taobao.com" );
    LCD_Dis_Str( 6,0,"24L01+:TX " );
    LCD_Dis_Str( 6, 80, (char*)testbuffer );

	/*??:
	1???????,??????,????????
	2????LED??????,???LED??????
	3?????:LED????,????:??LED??,????OK,?????????
	4???????????,???,????????
	*/
	while( 1 )
	{
        //????
        GPIO_Init( GPIOA, GPIO_Pin_3, GPIO_Mode_In_PU_No_IT );
        for( dly = 0; dly < 30000; dly ++ );
        //???????
        L01_FlushRX( );
        L01_FlushTX( );
        L01_WriteTXPayload_Ack( (INT8U*)"123\r\n", strlen( "123\r\n" ) );
        GPIO_SetBits( GPIOA, GPIO_Pin_2 );// CE = 1,????

        //????????,?????????
        while( GPIO_ReadInputDataBit( GPIOA, GPIO_Pin_3 ) != 0 );
        while( ( tmp = L01_ReadIRQSource( ) ) == 0 );
        GPIO_ResetBits( GPIOA, GPIO_Pin_2 );// ????,CE = 0,??

        if( tmp & ( 1<<TX_DS ) )
        {
            //????,LED??
            LED_Toggle( );

            tx_couter ++;
            itmp = tx_couter;
            testbuffer[0] = ( itmp / 10000 ) + '0';
            itmp %= 10000;
            testbuffer[1] = ( itmp / 1000 ) + '0';
            itmp %= 1000;
            testbuffer[2] = ( itmp / 100 ) + '0';
            itmp %= 100;
            testbuffer[3] = ( itmp / 10 ) + '0';
            itmp %= 10;
            testbuffer[4] = itmp + '0';
            testbuffer[5] = 0;
            LCD_Dis_Str( 6, 80, (char*)testbuffer );
        }
        if( tmp & ( 1<<MAX_RT ) )
        {
            //????,LED???
        }
        if( tmp & ( 1<<RX_DR )  )
        {

        }
        L01_ClearIRQ( IRQ_ALL );
	}
}