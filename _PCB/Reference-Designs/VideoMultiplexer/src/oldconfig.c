/*
 * config.c --
 *
 *     This file provides routines to configure the video encoder and decoders
 *     for the Video Multiplexer project.
 *
 *     Author: Peter Allworth (Linear Solutions Pty Ltd)
 */

#include  "i2c.h"

/*
 * Configuration for SAA7121 comes from Philips application note AN97086.
 * The chip is set up to work as a slave, detect sync sygnals out of the data stream,
 * PAL output format with WSS, TTX and closed caption disabled.
 */

static const __rom uchar cfgSAA7121[] = {
    38, 0x00, /* null */
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    9, 0x26, /* WSS, BS, BE, DECCOL, DECFIS, copyguard */
       0x00, 0x00, 0x21, 0x1D, 0x00, 0x00, 0x00, 0x00, 0x00,
    11, 0x2F, /* null */
       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    1, 0x3A, /* colour bar enable */
       0x93,
    6, 0x5A, /* CHPS, GAINU, GAINV, BLCKL, BLNNL */
       0x0C, 0x7D, 0xAF, 0x23, 0x35, 0x35,
    3, 0x60, /* FISE, PAL, etc., RTCE, BSTA */
       0x00, 0x06, 0x2F,
    4, 0x63, /* FSC (PAL) */
       0xCB, 0x8A, 0x09, 0x2A,
    4, 0x67, /* Line 21 captioning data. */
       0x55, 0x56, 0x67, 0x58,
    1, 0x6B, /* RCV1 & RCV2 configuration. */
       0x20,
    4, 0x6C, /* Teletext configuration (off). */
       0x05, 0x20, 0xA0, 0x14,
    3, 0x70, /* RCV2 start and end. */
       0x80, 0xE8, 0x10,
    7, 0x73, /* Teletext configuration (PAL). */
       0x42, 0x03, 0x03, 0x05, 0x16, 0x04, 0x16,
    3, 0x7A, /* FAL, LAL, TTX60. */
       0x18, 0x38, 0x40,
    1, 0x7D, /* null */
       0x00,
    2, 0x7E, /* LINE */
       0x00, 0x00,
    0        /* End of configuration table. */
};

/*
 * The following configuration is from Table 41 of the datasheet.
 */

static const __rom uchar cfgSAA7111A[] = {
    1, 0x01, 0x00,
    1, 0x02, 0xC0, /* Mode 0 -> CVBS from A11 input. */
    1, 0x03, 0x33,
    1, 0x04, 0x00,
    1, 0x05, 0x00,
    1, 0x06, 0xEB,
    1, 0x07, 0xE0,
    1, 0x08, 0x88,
    1, 0x09, 0x01,
    1, 0x0A, 0x80,
    1, 0x0B, 0x47,
    1, 0x0C, 0x40,
    1, 0x0D, 0x00,
    1, 0x0E, 0x01,
    1, 0x0F, 0x00,
    1, 0x10, 0xC0, /* OFTS = B'11' -> CCIR-656, 8-bits */
    1, 0x11, 0x1C,
    1, 0x12, 0x00,
    1, 0x13, 0x00,
    1, 0x14, 0x00,
    1, 0x15, 0x00,
    1, 0x16, 0x00,
    1, 0x17, 0x00,
    1, 0x18, 0x00,
    1, 0x19, 0x00,
    1, 0x1D, 0x00,
    1, 0x1E, 0x00,
    0
};

static int
Configure(uchar dev, __rom uchar table[])
{
    uchar __rom *p;
    uchar count, addr;
    int   n, total;

    total = 0;
    for(p = table; (count = *p++) > 0;) {
       addr = *p++;
       while (count-- != 0) {
          n = I2cPoke(dev, addr++, *p++);
          if (n < 0) {
             return n;
          } else if (n != 1) {
             return total;
          }
          total++;
       }
    }
    return total;
}

int
EncoderInit(uchar dev)
{
    return Configure(dev, cfgSAA7121);
}

int
DecoderInit(uchar dev)
{
    return Configure(dev, cfgSAA7111A);
}
